# SX1276/SX1278 APRS解码器 V2

[![License](https://img.shields.io/badge/license-MIT-blue.svg)](LICENSE)
[![Platform](https://img.shields.io/badge/platform-STM32-orange.svg)]()
[![Version](https://img.shields.io/badge/version-2.0-green.svg)]()

一个针对STM32平台优化的高性能APRS（Automatic Packet Reporting System）解码器，使用SX1276/SX1278射频模块。

---

## 📋 目录

- [功能特性](#功能特性)
- [系统架构](#系统架构)
- [硬件要求](#硬件要求)
- [软件依赖](#软件依赖)
- [安装指南](#安装指南)
- [配置说明](#配置说明)
- [使用方法](#使用方法)
- [技术原理](#技术原理)
- [性能优化](#性能优化)
- [故障排除](#故障排除)
- [开发计划](#开发计划)

---

## ✨ 功能特性

### 核心功能
- ✅ **AFSK解调**：支持Bell 202标准（1200Hz/2200Hz）
- ✅ **NRZI解码**：自动NRZI解码和比特去填充
- ✅ **AX.25解析**：完整的AX.25 UI帧解析
- ✅ **CRC校验**：CRC-16-CCITT错误检测
- ✅ **载波检测**：自动载波检测和同步
- ✅ **信号质量**：实时信号质量监测

### 高级特性
- 🚀 **DSP加速**：使用CMSIS-DSP库优化（支持FPU的MCU）
- 🚀 **自适应均衡**：可选的自适应均衡器
- 🚀 **DMA传输**：高效的DMA数据传输
- 🚀 **双缓冲机制**：无缝数据处理
- 📊 **统计信息**：详细的接收统计

### 支持的MCU
| MCU型号 | FPU | DSP | 推荐度 |
|---------|-----|-----|--------|
| STM32L412 | ✅ | ✅ | ⭐⭐⭐⭐⭐ |
| STM32F401 | ✅ | ✅ | ⭐⭐⭐⭐ |
| STM32F411 | ✅ | ✅ | ⭐⭐⭐⭐⭐ |
| STM32G431 | ✅ | ✅ | ⭐⭐⭐⭐⭐ |

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      SX1276/SX1278                         │
│               (FSK Direct Mode Output)                      │
└────────────────────┬────────────────────────────────────────┘
                     │ DIO2 (26.4kHz采样)
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                   AFSK解调器                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ Goertzel算法 │→ │  能量计算   │→ │   比特判决   │    │
│  │ (1200/2200Hz)│  │             │  │    (PLL)     │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└────────────────────┬────────────────────────────────────────┘
                     │ 解调后的比特流
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                   NRZI解码器                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  NRZI解码    │→ │  比特去填充  │→ │  帧标志检测  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└────────────────────┬────────────────────────────────────────┘
                     │ 字节流
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                  AX.25解析器                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │  地址解析    │→ │  CRC校验     │→ │  信息提取    │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└────────────────────┬────────────────────────────────────────┘
                     │ APRS消息
                     ↓
┌─────────────────────────────────────────────────────────────┐
│                  UART输出 (9600bps)                         │
│              格式: SOURCE>DEST:INFO                         │
└─────────────────────────────────────────────────────────────┘
```

### 模块说明

#### 1. **AFSK解调器** (`afsk_demod.cpp`)
- **Goertzel算法**：高效的单频检测
- **PLL位同步**：自动时钟恢复
- **能量计算**：Mark/Space频率能量比较
- **载波检测**：基于能量阈值的载波检测

#### 2. **NRZI解码器** (`nrzi_decoder.cpp`)
- **NRZI解码**：跳变→0，无跳变→1
- **比特去填充**：移除连续5个1后的填充0
- **帧标志检测**：识别0x7E标志

#### 3. **AX.25解析器** (`ax25_parser.cpp`)
- **地址解析**：源/目标/中继地址
- **CRC-16校验**：帧完整性验证
- **信息提取**：APRS负载数据

#### 4. **增强解码器** (`aprs_decoder_enhanced.cpp`)
- **CMSIS-DSP优化**：使用ARM DSP指令
- **FIR滤波**：带通滤波器
- **自适应均衡**：补偿信道失真
- **批量处理**：DMA批处理支持

---

## 🔌 硬件要求

### 必需硬件
- **STM32开发板**（L412/F401/F411/G431）
- **SX1276或SX1278模块**
- **天线**（适合工作频率）

### 引脚连接

| SX1276引脚 | STM32引脚 | 说明 |
|------------|-----------|------|
| NSS | PA4 | SPI片选 |
| MOSI | PA7 | SPI数据输出 |
| MISO | PA6 | SPI数据输入 |
| SCK | PA5 | SPI时钟 |
| DIO0 | PA2 | 中断引脚 |
| **DIO2** | **PA3** | **直接模式采样（关键）** |
| RESET | PA1 | 复位引脚 |
| GND | GND | 地 |
| VCC | 3.3V | 电源 |

**注意**：DIO2引脚是关键采样引脚，必须连接正确！

### UART连接
| 功能 | 引脚 | 波特率 |
|------|------|--------|
| 调试输出 | USB串口 | 115200 |
| **APRS输出** | **UART1 (PA9)** | **9600** |

---

## 📦 软件依赖

### Arduino IDE配置
1. 安装 **Arduino IDE** 1.8.19 或更高版本
2. 安装 **STM32duino** 板卡支持：
   - 在板卡管理器中搜索 "STM32"
   - 安装 "STM32 MCU based boards" by STMicroelectronics

### 必需库
```
RadioLib (>= 6.0.0)     // 射频模块驱动
```

安装方法：
```
Arduino IDE -> 工具 -> 管理库 -> 搜索 "RadioLib" -> 安装
```

### 可选库（DSP支持）
对于支持DSP的MCU，需要CMSIS-DSP库（通常STM32duino已包含）。

---

## 🚀 安装指南

### 1. 克隆代码
```bash
git clone https://github.com/your-repo/sx1276-aprs-decoder-v2.git
cd sx1276-aprs-decoder-v2
```

### 2. 打开项目
- 用Arduino IDE打开 `sx1276-aprs-decoder.ino`

### 3. 配置Arduino IDE
- **板卡选择**：工具 → 板卡 → STM32 boards groups → 选择你的MCU
  - 例如：Generic STM32L4 series
- **板卡型号**：选择具体型号（如 Generic L412KBUx）
- **上传方式**：STLink 或 Serial
- **优化级别**：选择 "Fast (-O2)" 或 "Fastest (-O3)"

### 4. 配置解码器（可选）
编辑 `src/aprs_config.h`：
```cpp
#define RF_FREQUENCY        144.39      // APRS频率 (MHz)
#define UART_BAUDRATE       9600        // UART波特率
#define DEBUG_ENABLED       1           // 启用调试输出
```

### 5. 编译上传
- 点击 "验证" 按钮编译
- 点击 "上传" 按钮上传到STM32

### 6. 测试
- 打开串口监视器（115200 bps）
- 观察启动信息和解码输出

---

## ⚙️ 配置说明

### 频率配置
**重要**：默认配置使用434.0 MHz作为测试频率。使用APRS频段前请确保：
- 持有业余无线电执照
- 修改 `RF_FREQUENCY` 为合法频率

常用APRS频率：
| 地区 | 频率 (MHz) |
|------|-----------|
| 北美 | 144.390 |
| 欧洲 | 144.800 |
| 日本 | 144.660 |
| 中国 | 144.640 |
| 澳洲 | 145.175 |

### 采样率配置
```cpp
#define AFSK_SAMPLE_RATE    26400       // Hz - 采样频率
```
26.4 kHz 可被1200和2200整除，是最优采样率。不建议修改。

### 调试输出
```cpp
#define DEBUG_ENABLED       1           // 1=启用，0=禁用
```
禁用调试输出可节省内存和CPU资源。

### DSP优化
DSP优化会自动根据MCU型号启用。可在 `src/aprs_decoder_enhanced.cpp` 中调整：
```cpp
// 启用自适应均衡器
decoder.enableAdaptiveEqualizer(true);
```

---

## 📖 使用方法

### 基本使用
1. 上传代码到STM32
2. 连接天线到SX1276
3. 打开串口监视器（115200 bps）
4. 等待APRS信号

### 输出格式

#### 调试输出（Serial，115200 bps）
```
╔════════════════════════════════════════╗
║       接收到APRS帧！                  ║
╚════════════════════════════════════════╝
源地址: N7LEM-5
目标地址: APRS
信息字段: !3745.12N/12205.34W>Hello APRS
信号质量: 87%
----------------------------------------
```

#### APRS输出（UART1，9600 bps）
```
N7LEM-5>APRS:!3745.12N/12205.34W>Hello APRS
```

### 统计信息
每10秒输出一次统计：
```
┌─── 统计信息 ───────────────────────┐
│ 接收帧数: 25
│ 有效帧数: 23
│ CRC错误: 2
│ 接收字节: 1024
└────────────────────────────────────┘
```

---

## 🔬 技术原理

### AFSK调制原理
AFSK（Audio Frequency Shift Keying）使用两个不同频率表示0和1：
- **Mark（1）**：2200 Hz
- **Space（0）**：1200 Hz

采样率为26.4 kHz，每个比特周期包含22个采样点：
```
26400 / 1200 = 22 samples/bit
```

### Goertzel算法
Goertzel算法是一种高效的单频检测算法，相比FFT更适合检测特定频率：

```cpp
// Goertzel算法核心
omega = 2π × freq / sampleRate
coeff = 2 × cos(omega)

for each sample:
    q0 = coeff × q1 - q2 + sample
    q2 = q1
    q1 = q0

magnitude² = q1² + q2² - q1×q2×coeff
```

### NRZI编码
NRZI（Non-Return-to-Zero Inverted）：
- **无跳变** = 1
- **有跳变** = 0

这种编码避免了长串0导致的时钟同步丢失。

### PLL位同步
使用数字PLL进行比特同步：
```cpp
pllPhase += pllDPhase

if (transition detected):
    if (pllPhase < halfway):
        pllDPhase -= adjustment  // 减慢时钟
    else:
        pllDPhase += adjustment  // 加快时钟
```

### AX.25帧格式
```
┌─────────┬─────────┬─────────┬──────────┬─────┬──────┬─────────┐
│  Flag   │ Address │ Address │ Control  │ PID │ Info │  FCS   │
│  0x7E   │ (Dest)  │ (Source)│   0x03   │0xF0 │      │(2bytes)│
└─────────┴─────────┴─────────┴──────────┴─────┴──────┴─────────┘
```

---

## ⚡ 性能优化

### 基础解码器性能
- **CPU占用率**：约40-60%（F4系列@84MHz）
- **内存使用**：约8KB RAM
- **解码成功率**：>95%（良好信号条件）

### 增强解码器性能（DSP优化）
- **CPU占用率**：约25-40%（使用硬件加速）
- **解码成功率**：>98%（带自适应均衡）
- **加速比**：约1.5-2x

### 优化建议

#### 1. 编译器优化
Arduino IDE设置：
```
工具 → 优化 → Fastest (-O3)
```

#### 2. 时钟频率
使用最高系统时钟：
- STM32L412: 80 MHz
- STM32F401: 84 MHz
- STM32F411: 100 MHz
- STM32G431: 170 MHz

#### 3. 禁用调试输出
生产环境中：
```cpp
#define DEBUG_ENABLED       0
```

#### 4. 使用DMA
启用DMA批量处理可降低中断开销。

---

## 🐛 故障排除

### 问题1：无法接收信号
**症状**：没有任何帧输出

**排查步骤**：
1. 检查天线连接
2. 检查频率设置（`RF_FREQUENCY`）
3. 检查DIO2引脚连接
4. 确认载波检测：
   ```cpp
   DEBUG_PRINT("Carrier: ");
   DEBUG_PRINTLN(afskDemod.isCarrierDetected());
   ```

### 问题2：CRC错误率高
**症状**：接收到帧但CRC错误多

**可能原因**：
- 信号太弱
- 频率偏移
- 采样时钟不准

**解决方法**：
1. 改善天线位置
2. 调整PLL参数：
   ```cpp
   // 在afsk_demod.cpp中调整
   pllDPhase = 0x10000 / SAMPLES_PER_BIT;
   ```

### 问题3：编译错误
**错误**：`'arm_fir_instance_f32' does not name a type`

**解决**：
- 检查是否安装了CMSIS-DSP
- 临时禁用DSP：
  ```cpp
  #define USE_CMSIS_DSP     0
  ```

### 问题4：UART无输出
**检查**：
1. UART引脚连接
2. 波特率设置（9600）
3. 使用USB-TTL转换器测试

---

## 📊 性能测试

### 测试环境
- MCU: STM32F411CEU6 @100MHz
- 编译优化: -O3
- 信号强度: -80 dBm

### 测试结果
| 测试项 | 基础解码器 | 增强解码器 |
|--------|-----------|-----------|
| CPU占用 | 58% | 35% |
| 解码成功率 | 94.3% | 97.8% |
| 平均延迟 | 120ms | 85ms |
| CRC错误率 | 5.7% | 2.2% |

---

## 🛣️ 开发计划

### v2.1（计划中）
- [ ] 支持9600 bps G3RUH调制
- [ ] 增加频谱显示功能
- [ ] Web界面配置

### v2.2（计划中）
- [ ] SD卡日志记录
- [ ] GPS时间同步
- [ ] iGate功能

### v3.0（长期计划）
- [ ] 双频同时接收
- [ ] APRS发射功能
- [ ] 数字中继器模式

---

## 📄 许可证

本项目采用MIT许可证 - 详见 [LICENSE](LICENSE) 文件

---

## 🙏 致谢

- **RadioLib** - jgromes：优秀的射频库
- **CMSIS-DSP** - ARM：DSP优化库
- **STM32duino** - 社区：Arduino移植

---

## 📞 联系方式

- **问题反馈**：[GitHub Issues](https://github.com/your-repo/sx1276-aprs-decoder-v2/issues)
- **邮件**：your-email@example.com

---

## ⚠️ 免责声明

**重要提示**：
1. 本项目仅供学习和研究使用
2. 在APRS频段发射前，请确保持有有效的业余无线电执照
3. 遵守当地无线电管理法规
4. 作者不对非法使用承担任何责任

---

**祝您使用愉快！73！** 📻

