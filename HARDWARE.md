# 硬件连接指南

本文档提供详细的硬件连接说明和电路设计建议。

## 目录

1. [引脚连接](#引脚连接)
2. [推荐硬件清单](#推荐硬件清单)
3. [天线设计](#天线设计)
4. [电源要求](#电源要求)
5. [PCB设计建议](#pcb设计建议)
6. [故障排除](#故障排除)

---

## 引脚连接

### ESP32C3 ↔ SX1276/SX1278

| ESP32C3 | SX1276/SX1278 | 功能说明 | 备注 |
|---------|---------------|---------|------|
| GPIO 5  | NSS (CS)      | SPI片选 | 低电平有效 |
| GPIO 18 | SCK           | SPI时钟 | 默认SPI引脚 |
| GPIO 19 | MISO          | SPI数据输入 | 默认SPI引脚 |
| GPIO 23 | MOSI          | SPI数据输出 | 默认SPI引脚 |
| GPIO 2  | DIO0          | 中断/状态 | 可选，用于数据包检测 |
| GPIO 9  | RESET         | 复位引脚 | 低电平复位 |
| GPIO 3  | DIO1          | 中断/状态 | 可选 |
| GPIO 4  | DIO2          | 数据输出 | **关键！直接模式数据** |
| 3.3V    | VCC           | 电源 | 稳定的3.3V |
| GND     | GND           | 地 | 多点接地 |

### UART输出连接

| ESP32C3 | 外部设备 | 功能说明 |
|---------|---------|---------|
| GPIO 21 | RX      | UART发送 (9600 baud) |
| GPIO 20 | TX      | UART接收 (可选) |
| GND     | GND     | 公共地 |

### 接线图

```
                    ┌──────────────────┐
                    │    ESP32C3       │
                    │                  │
         GPIO 5 ────┤ NSS              │
        GPIO 18 ────┤ SCK              │
        GPIO 19 ────┤ MISO             │
        GPIO 23 ────┤ MOSI             │
         GPIO 2 ────┤ DIO0    UART TX  ├──── GPIO 21 (TNC2输出)
         GPIO 9 ────┤ RESET   UART RX  ├──── GPIO 20
         GPIO 3 ────┤ DIO1             │
         GPIO 4 ────┤ DIO2             │
           3.3V ────┤ VCC              │
            GND ────┤ GND              │
                    └──────────────────┘
                           │││││
                           │││││  SPI + Control
                           VVVVV
                    ┌──────────────────┐
                    │   SX1276/SX1278  │
                    │                  │
                    │              ANT ├──── 144 MHz天线
                    └──────────────────┘
```

---

## 推荐硬件清单

### 必需组件

1. **ESP32C3开发板**
   - ESP32-C3-DevKitM-1 (官方)
   - ESP32-C3-MINI-1 模块
   - 或其他兼容ESP32C3开发板
   - **价格**：约 ¥15-30

2. **SX1276/SX1278模块**
   - LoRa1276/1278模块 (144 MHz版本)
   - 推荐型号：
     - Hope RF RFM95W (144 MHz)
     - Dorji DRF1278F (144 MHz)
   - **价格**：约 ¥20-40
   - **注意**：确认支持144 MHz频段！

3. **天线**
   - 144 MHz 1/4波长天线
   - 或SMA接口可调天线
   - **价格**：约 ¥10-30

4. **电源**
   - 5V USB电源 (至少500mA)
   - 或3.7V锂电池 + 升压/稳压模块

### 可选组件

1. **外壳**
   - 防水外壳（户外使用）
   - 散热外壳（长时间运行）

2. **天线连接器**
   - SMA公头/母头
   - U.FL转SMA转接线

3. **调试工具**
   - USB转串口模块（如果需要额外UART调试）
   - 逻辑分析仪（开发调试用）

### 估算总成本

| 配置 | 价格 |
|------|------|
| 最小系统 | ¥45-100 |
| 推荐配置 | ¥80-150 |
| 完整套件（含外壳） | ¥120-200 |

---

## 天线设计

### 144 MHz天线参数

**基本参数**：
- 频率：144.64 MHz (中国APRS频率)
- 波长：λ = c/f = 300/144.64 ≈ 2.07米
- 1/4波长：λ/4 ≈ 51.8 cm

### 简易1/4波天线制作

**材料**：
- 1根 52 cm铜线/钢丝（辐射体）
- 4根 13 cm铜线/钢丝（地平面）
- SMA连接器

**结构**：

```
         │ 52 cm (竖直)
         │
         │
    ─────┴───── SMA连接器
   ╱  ╱  │  ╲  ╲
  ╱  ╱   │   ╲  ╲  地平面 (4根，每根13 cm，45°向下)
```

**制作步骤**：
1. 将52 cm铜线焊接到SMA中心导体
2. 将4根13 cm铜线均匀分布焊接到SMA外壳
3. 将地平面线向下弯曲约45°
4. 测试驻波比（理想情况 < 1.5:1）

### 商用天线推荐

| 类型 | 增益 | 适用场景 | 价格 |
|------|------|---------|------|
| 1/4波鞭状天线 | 0 dBi | 室内测试 | ¥10-20 |
| 1/2波天线 | 2-3 dBi | 便携/车载 | ¥30-50 |
| 5/8波天线 | 3-5 dBi | 固定站 | ¥50-100 |
| 八木天线 | 8-12 dBi | 定向接收 | ¥100-300 |

---

## 电源要求

### 功耗分析

**ESP32C3**：
- 运行模式：~80 mA @ 3.3V
- 峰值电流：160 mA

**SX1278接收模式**：
- 正常接收：~12 mA @ 3.3V
- 直接模式：~15 mA @ 3.3V

**总计**：
- 平均功耗：~95 mA @ 3.3V ≈ 315 mW
- 峰值功耗：~175 mA @ 3.3V ≈ 580 mW

### 电源方案

#### 方案1：USB供电（推荐）

```
5V USB ──> ESP32C3开发板 (内置3.3V稳压器) ──> SX1278
```

- **优点**：简单、稳定
- **缺点**：需要外部电源
- **适用**：固定站、测试

#### 方案2：锂电池供电

```
3.7V Li-Po ──> 3.3V LDO (AMS1117-3.3) ──> ESP32C3 + SX1278
            └─> 电池充电管理（TP4056）
```

- **优点**：便携
- **缺点**：需要充电
- **运行时间**：2000mAh电池约20小时

#### 方案3：太阳能供电

```
6V太阳能板 ──> 充电控制器 ──> 3.7V电池 ──> 3.3V稳压 ──> 系统
```

- **优点**：长期户外部署
- **适用**：固定监测站

### 电源滤波建议

在电源输入端添加：
1. **100 μF电解电容**（靠近稳压器输入）
2. **10 μF陶瓷电容**（靠近ESP32C3）
3. **0.1 μF陶瓷电容**（靠近SX1278）

---

## PCB设计建议

### 布局原则

1. **分区设计**：
   - 数字区（ESP32C3）
   - 射频区（SX1278）
   - 电源区（稳压器）

2. **接地**：
   - 使用完整地平面
   - 射频地单点连接到数字地

3. **走线**：
   - SPI信号线尽量短
   - DIO2信号线使用50Ω阻抗控制
   - 天线馈线使用50Ω微带线

### 推荐层叠

**2层板**：
```
顶层：信号 + 元件
底层：完整地平面
```

**4层板**（推荐）：
```
L1：信号 + 元件
L2：地平面
L3：电源平面
L4：信号
```

### 射频设计要点

1. **天线匹配**：
   - SX1278的射频输出已经是50Ω
   - 使用SMA连接器
   - 天线馈线长度尽量短

2. **EMI抑制**：
   - 在天线馈线上串联磁珠
   - 在电源输入端添加LC滤波器

---

## 故障排除

### 问题1：无法初始化SX1278

**症状**：串口显示"SX1278 initialization failed"

**可能原因**：
- SPI连接错误
- 电源不足
- 模块损坏

**排查步骤**：
1. 用万用表测量SX1278的VCC引脚，确认3.3V
2. 检查NSS、SCK、MISO、MOSI连接
3. 尝试降低SPI速度
4. 更换SX1278模块

### 问题2：接收不到任何信号

**症状**：系统运行正常但无输出

**可能原因**：
- 天线未连接或驻波比过高
- 频率设置错误
- 本地无APRS信号

**排查步骤**：
1. 检查天线连接
2. 确认`APRS_FREQUENCY`设置正确（144.64 MHz）
3. 使用手机APRS应用测试发射
4. 增加调试输出观察信号质量

### 问题3：CRC错误率高

**症状**：接收到信号但大部分FCS校验失败

**可能原因**：
- 信号过强（饱和）
- 信号过弱
- 解调参数不匹配

**排查步骤**：
1. 检查RSSI值
2. 调整`ENERGY_THRESHOLD_RATIO`
3. 增加`DEMOD_WINDOW_SIZE`
4. 改善天线位置/方向

### 问题4：系统重启或崩溃

**症状**：运行一段时间后重启

**可能原因**：
- 内存溢出
- 堆栈溢出
- 看门狗超时

**排查步骤**：
1. 监控空闲堆内存
2. 减小缓冲区大小
3. 降低调试输出级别
4. 检查是否有死循环

---

## 测试和校准

### 1. 频率校准

使用频谱分析仪或SDR验证：
```cpp
radio.setFrequency(144.64);  // MHz
```

### 2. RSSI测量

添加代码读取RSSI：
```cpp
int16_t rssi = radio.getRSSI();
Serial.printf("RSSI: %d dBm\n", rssi);
```

理想RSSI范围：-80 ~ -100 dBm

### 3. 发射测试

使用手机APRS应用（如APRSdroid）发射测试包。

### 4. 环回测试

使用两套设备，一个发射一个接收，验证端到端功能。

---

## 升级和扩展

### 可能的改进方向

1. **添加GPS模块**：实现移动站功能
2. **添加显示屏**：OLED显示接收消息
3. **添加LoRa发射**：双向APRS通信
4. **多频段支持**：支持430 MHz等其他频段
5. **网络上传**：通过WiFi上传到APRS-IS服务器

### 兼容的GPS模块

- Neo-6M / Neo-7M
- 连接到ESP32C3的UART2
- 添加代码解析NMEA数据

---

## 安全警告

⚠️ **重要提示**：

1. **不要发射**：本项目仅实现接收功能
2. **许可要求**：使用APRS频段需要业余无线电执照
3. **频率合规**：确认当地法规允许的频率
4. **电气安全**：注意防止短路和过热
5. **天线安全**：避免天线接触高压线路

---

## 参考资料

- [ESP32C3技术手册](https://www.espressif.com/sites/default/files/documentation/esp32-c3_datasheet_cn.pdf)
- [SX1276/78数据手册](https://www.semtech.com/products/wireless-rf/lora-core/sx1276)
- [天线设计基础](https://www.arrl.org/antenna-design)

---

**需要帮助？** 请在GitHub Issues提问或加入讨论。

